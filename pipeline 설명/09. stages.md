# 09. stages
[stages 공식문서](https://www.jenkins.io/doc/book/pipeline/syntax/#stages)
## 목적 : 다른 태그들은 모두 편의를 위한 옵션에 불과했으며 <br>실질적인 기능을 수행하는 모든 구문은 여기서 작성된다.
## stages는 필수 태그이며 하위태그로 1개 이상의 stage("")를 사용한다. 괄호 내부에는 내가 구별하기 위한 명칭을 대입하면 된다. 해당 명칭은 빌드할때 다음과 같이 표시되며, 각 stage마다 로그를 확인할 수 있습니다.
![stage](/images/stage.png)
## stage 하위 태그로는 다음의 4가지 중 1가지를 사용하여야 한다. 순차실행(steps), 순차실행 세분화(stages), 병렬 동시 실행(parallel), 경우의 수별로 순차 또는 병렬실행(matrix). 하나씩 살펴보겠다.

### 1. steps : steps 블럭 내부에 실제로 수행할 내용을 한줄씩 입력하면 된다. 순차적으로 실행된다.
```groovy
pipeline {
    agent any
    environment { //전역변수 저장
        SERVER_CREDENTIALS = credentials('credentials 식별자')
    }
    stages { // jenkins 컨테이너일 때)내부의 /var/jenkins_home/workspace/{myJobName}에서 실행된다
        stage("git clone") {
            steps { // git은 steps 내부 함수다. 현재 위치에 .git x -> git clone, .git o -> fetch만 수행
                git url: "GitURL", // 해당 옵션만 줘도 작동한다. 해당 url에서 git clone을 수행한다
                    credentialsId: "credentials 식별자", //public repository면 해당 로그인 정보가 필요없다
                    branch: "main" //해당 옵션을 안 줄 경우 master로 수행한다
            }
        }
        stage('docker push') {
            steps {
                sh 'docker login -u $SERVER_CREDENTIALS_USR -p $SERVER_CREDENTIALS_PSW HarborURL'
                sh "docker build -t imgName ."
                sh "docker push HarborURL" //여기서 harbor url = imgName의 형식으로 맞춰둔다
            }
        }
    }
}
```

#### 1-1) when : when은 stage의 하위 태그로 조건검사를 통해 해당 stage 내부의 기능을 담당하는 steps, stages, parallel, matrix를 수행할지 결정할 수 있다.<br>여기서는 when의 하위태그 중 일부만을 소개한다. 더 필요한 사항은 공식문서를 참고하자
[when 공식문서](https://www.jenkins.io/doc/book/pipeline/syntax/#when)
environment : 해당 이름의 environment 값이 value일 때 조건검사를 통과한다.  
```groovy
pipeline {
    agent any
    environment {
        DEPLOY_TO = "production"
    }
    stages {
        stage {
            when {
                environment name: 'DEPLOY_TO', value: 'production'
            }
            steps {
                sh "echo hi"
                junit 'reports/**/*.xml'  // junit 플러그인을 통해 제공하는 기능으로, 테스트 보고서를 집계한다.
            }
        }
    }
}
```
expression : if 문과 같다. true, false만 검사한다.  
```groovy
pipeline {
    agent any

    stages {
        stage {
            when { 
                expression {
                    currentBuild.result == null || currentBuild.result == 'SUCCESS' // 파이프라인 테스트 실패시 해당 값은 UNSTABLE 이다.
                }
            }
            steps {
                sh "echo hi"
                junit 'reports/**/*.xml'  // junit 플러그인을 통해 제공하는 기능으로, 테스트 보고서를 집계한다.
            }
        }
    }
}
```
다음 조건에서 실행 allOf: all true, not: all false, anyOf: 1개이상 true  
```groovy
pipeline {
    agent any
    stages {
        stage('Example Build') {
            steps {
                echo 'Hello World'
            }
        }
        stage('Example Deploy') {
            when {
                allOf { //다음 조건에서 실행 allOf: all true, not: all false, anyOf: 1개이상 true
                    branch 'production'
                    environment name: 'DEPLOY_TO', value: 'production'
                }
            }
            steps {
                echo 'Deploying'
            }
        }
    }
}
```

#### 1-2) input : 빌드 실행도중 값을 입력받는다. 아직은 필요성이 없어 생략한다.

#### 1-3) script : scripted pipeline block 을 가져와서 groovy 를 사용가능. if - else, try - catch 도 사용가능하다.
```groovy
def gv;
pipeline {
    agent any

    stages {
        stage {
            steps {
                script {
                    def browsers = ['chrome', 'firefox']
                    for (int i = 0; i < browsers.size(); ++i) {
                        echo "Testing the ${browsers[i]} browser"
                    }
                    gv = load "script.groovy" //외부 모듈을 불러올 수 있다. pipeline 위에 먼저 선언해야한다.
                    gv.buildApp()
                    gv.testApp()
                }
            }
        }
    }
}
```
위에서 정의한 외부모듈이 될 파일
파일명 : script.groovy
```groovy
def buildApp() {
    echo "building the application…"
}

def testApp() {
    echo "testing the application… ${params.Version}" // 다음과 같은 변수도 사용 가능하다
}

return this
```

### 2. stages : 
```groovy
pipeline {
    agent any
    environment { //전역변수 저장
        SERVER_CREDENTIALS = credentials('credentials 식별자')
    }
    stages {
        stage('Example') {
            steps {
                sh 'docker login -u $SERVER_CREDENTIALS_USR -p $SERVER_CREDENTIALS_PSW HarborURL'
            }
        }
    }
}
```

### 3. parallel : 
```groovy
pipeline {
    agent any
    environment { //전역변수 저장
        SERVER_CREDENTIALS = credentials('credentials 식별자')
    }
    stages {
        stage('Example') {
            steps {
                sh 'docker login -u $SERVER_CREDENTIALS_USR -p $SERVER_CREDENTIALS_PSW HarborURL'
            }
        }
    }
}
```

### 4. matrix : 
```groovy
pipeline {
    agent any
    environment { //전역변수 저장
        SERVER_CREDENTIALS = credentials('credentials 식별자')
    }
    stages {
        stage('Example') {
            steps {
                sh 'docker login -u $SERVER_CREDENTIALS_USR -p $SERVER_CREDENTIALS_PSW HarborURL'
            }
        }
    }
}
```

### 다음 > [10. post](10.%20post.md)
